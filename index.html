<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>舞岩抱石攀岩館 責任風險承擔同意書</title>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.5/dist/signature_pad.umd.min.js"></script>
  <style>
    :root { --main-blue: #2064bb; }
    body {
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'PingFang TC', sans-serif;
      background: #f5f7fa;
      margin: 0;
      color: #232629;
    }
    .main-card {
      background: #fff;
      max-width: 600px;
      margin: 2em auto;
      border-radius: 18px;
      box-shadow: 0 4px 18px #2260a71c;
      padding: 2em 2.2em 1.4em 2.2em;
      position: relative;
    }
    @media (max-width:700px) {
      .main-card {
        padding: 1.1em 4vw 1.2em 4vw;
        border-radius: 0;
        margin: 0;
        box-sizing: border-box;
      }
    }
    .site-title {
      text-align: center;
      color: var(--main-blue);
      font-size: 2.6em;
      font-weight: 900;
      letter-spacing: 2px;
      margin-bottom: 0.2em;
      margin-top: 0;
      font-family: 'Noto Sans TC', 'Microsoft JhengHei', 'PingFang TC', sans-serif;
      line-height: 1.1;
    }
    @media (max-width:600px) {
      .site-title { font-size: 2em; }
    }
    h2.page-title {
      text-align: center;
      color: var(--main-blue);
      margin: 0 0 1em 0;
      font-size: 1.28em;
      font-weight: 700;
      letter-spacing: 1.2px;
    }
    .terms-block {
      background: #e9f0fb;
      border-radius: 10px;
      padding: 1.5em 1.3em 1.3em 1.3em;
      margin-bottom: 1.1em;
      max-height: 570px;
      overflow-y: auto;
      font-size: 1.11em;
      color: #233;
      box-sizing: border-box;
    }
    @media (max-width:600px) {
      .main-card { max-width: 100vw; }
      .terms-block { max-height: 430px; font-size: 0.99em;}
      .site-title { font-size: 2em; }
      h2.page-title { font-size: 1.08em; }
    }
    .terms-block h3, .terms-block h4 {
      color: var(--main-blue);
    }
    .terms-block h3 {
      margin: 0.8em 0 0.2em 0;
      font-size: 1.09em;
      font-weight: bold;
      letter-spacing: 1px;
      border-left: 4px solid var(--main-blue);
      padding-left: 0.55em;
    }
    .terms-block h4 {
      margin: 1.1em 0 0.4em 0;
      font-size: 1.01em;
      font-weight: bold;
      letter-spacing: 1px;
    }
    .terms-block ul {
      margin: 0.15em 0 0.7em 1.7em;
      font-size: 0.99em;
      line-height: 1.8;
      color: #233;
      padding-left: 0.2em;
    }
    .terms-block li {margin-bottom: 0.44em;}
    .terms-block .sub-desc {
      margin: 0.35em 0 0.9em 0.8em;
      color: #4a4c50;
      font-size: 0.97em;
      line-height: 1.7;
    }
    .checkbox-block { background: #f7fbff; border-radius: 8px; padding: 1em 1.2em; margin-bottom: 1.2em; display: flex; flex-direction: column; gap: 0.9em; font-size: 1.11em; color: var(--main-blue);}
    .checkbox-block label { display: flex; align-items: flex-start; gap: 0.6em; font-weight: 500; color: var(--main-blue); cursor: pointer;}
    label { display: block; margin: 1em 0 0.2em 0; color: var(--main-blue); font-weight: 500; letter-spacing: 1px; }
    input[type="text"], input[type="tel"], input[type="date"], select { width: 100%; padding: 0.48em; border-radius: 6px; border: 1px solid #bcd; font-size: 1em; box-sizing: border-box; background: #f8fafc; transition: border .15s; color: #232629;}
    input[type="text"]:focus, input[type="tel"]:focus, input[type="date"]:focus { outline: 2px solid #398be8; border-color: #398be8; }
    .radio-group { display: flex; gap: 2.2em; margin: 0.42em 0 0.8em 0; align-items: center; }
    .radio-group label { font-weight: 400; color: #232629; font-size: 1em; margin: 0; }
    .nav-btns { margin-top: 1.5em; display: flex; justify-content: space-between; gap: 0.6em; }
    .nav-btns button, .submit-btn {
      background: var(--main-blue);
      border: none;
      color: #fff;
      padding: 0.8em 2.1em;
      border-radius: 999px;
      font-size: 1.13em;
      font-weight: bold;
      box-shadow: 0 2px 10px #0c237a18;
      cursor: pointer;
      transition: background 0.15s;
      letter-spacing: 1px;
    }
    .nav-btns button:hover, .submit-btn:hover { background: #17497e; }
    .submit-btn { width: 100%; margin-top: 1.6em; }
    .canvas-block { margin: 1.7em 0 1.2em 0; }
    .canvas-block label { font-weight: 600; color: var(--main-blue); margin-bottom: 0.5em; margin-top: 0.3em; }
    .sign-canvas { border: 1.5px solid #b4cdf7; border-radius: 10px; width: 100%; height: 120px; background: #fff; box-shadow: 0 2px 8px #3774bb18; touch-action: none; }
    .clear-btn { margin-top: 0.6em; background: #999; border: none; color: #fff; border-radius: 7px; padding: 0.45em 1.5em; font-size: 1em; font-weight: 500; cursor: pointer; transition: background 0.2s; margin-right: 0.7em; }
    .clear-btn:hover { background: #5d6673; }
    .err-msg { color: #dc3545; font-size: 0.97em; margin-top: 0.3em; margin-bottom: 0.4em; }
    #success-msg, #final-page { color: var(--main-blue); font-size: 1.13em; text-align: center; margin-top: 2em; }
    .page-title {margin-bottom: 1.5em;}
    .final-btn {
      display: inline-block;
      margin-top: 2.1em;
      background: var(--main-blue);
      color: #fff;
      border: none;
      border-radius: 999px;
      padding: 1em 2.8em;
      font-size: 1.15em;
      font-weight: bold;
      cursor: pointer;
      letter-spacing: 1.2px;
      transition: background 0.18s;
    }
    .final-btn:hover { background: #17497e; }
  </style>
</head>
<body>
<div class="main-card">
  <div class="site-title">舞岩抱石攀岩館</div>
  <div id="form-stepper">
    <form id="waiverForm" autocomplete="off">
      <!-- Step 1 條款一 -->
      <div id="step-1" style="display:block">
        <h2 class="page-title">責任與風險承擔同意書</h2>
        <div class="terms-block">
          <h3>《責任與風險承擔同意書》</h3>
          <div class="sub-desc">為了確保您的安全與知情權，請詳閱本同意書內容。</div>
          <h4>一、活動風險告知</h4>
          <div class="sub-desc">
            本人知悉並理解參與攀岩或相關運動具有以下潛在風險，包括但不限於：
          </div>
          <ul>
            <li>身體損傷（如扭傷、拉傷、骨折、瘀青、擦傷等）</li>
            <li>器材使用不當</li>
            <li>與他人碰撞或場地內意外</li>
            <li>任何因參與本活動而導致的心理或身體不適</li>
          </ul>
          <div class="sub-desc">
            本人理解即使遵守所有安全規定，這些風險無法完全避免，且本人願意自行承擔所有風險。
          </div>
          <h4>二、參與者聲明</h4>
          <ol>
            <li>本人保證身心健康，無不適合從事劇烈運動之疾病或心理問題（如心臟病、癲癇、懷孕等）。</li>
            <li>本人將遵守工作人員指示與安全規範，不進行危險行為或未經授權之操作。</li>
            <li>本人同意在攀岩過程中隨時注意自身及他人的安全，並遵守基本的攀岩禮節和場館安全規範。在攀爬過程中，若發現安全隱患或不適，將立即停止並向場館工作人員報告。</li>
            <li>本人已完整閱讀並理解活動規則及風險說明，願意自行承擔活動中可能產生之風險與責任。</li>
          </ol>
          <h4>三、免責與賠償聲明</h4>
          <ol>
            <li>本人同意如因本人行為不當、違反規定、個人疏忽或其他非場地方責任因素所導致之任何事故、傷害、財物損失，將自行負責，並放棄對舞岩抱石攀岩館館方、教練或工作人員之一切追訴或賠償要求。</li>
            <li>如本人行為導致第三人受損害，願意自行負擔相應賠償責任。</li>
            <li>舞岩抱石攀岩館提供基本的場地保險，該保險僅涵蓋場館內設施的意外責任，不涵蓋參與者個人健康或意外風險。建議參與者自行投保額外的運動意外險以增加保障。</li>
          </ol>
          <h4>四、個人資料使用</h4>
          <div class="sub-desc">
            本人同意舞岩抱石攀岩館有權拍攝本人參與活動過程中的照片及影像，並可將其用於紀錄、宣傳或其他商業用途。如不同意該用途，本人將提前通知工作人員。
          </div>
        </div>
        <div class="checkbox-block">
          <label><input type="checkbox" id="agree1" required> 我已詳細閱讀並同意上述條款內容</label>
        </div>
        <div class="nav-btns">
          <span></span>
          <button type="button" id="to-step-2">下一頁</button>
        </div>
      </div>
      <!-- Step 2 條款二 -->
      <div id="step-2" style="display:none">
        <h2 class="page-title">入場須知與安全守則</h2>
        <div class="terms-block" style="margin-bottom: 1.1em;">
          <h3>《入場須知與安全守則》</h3>
          <ul>
            <li>入館前請完成登記與付費，並請向工作人員確認安全墜落姿勢。</li>
            <li>5歲以下不得參與攀岩。未滿9歲（或未滿國小三年級）需由家長或法定監護人陪同。</li>
            <li>未滿18歲者需由監護人簽署同意書。</li>
            <li>進行抱石時請穿著攀岩鞋，不可赤腳攀爬。</li>
            <li>攀登區嚴禁飲食，水壺請放指定區。</li>
            <li>勿將物品放置於軟墊上。</li>
            <li>本館全面禁煙、禁止酒精、口香糖、檳榔。</li>
            <li>館內禁止奔跑、打鬧、玩耍。</li>
            <li>通過攀登區時應注意牆上攀登者並快速通過。</li>
            <li>嚴禁於軟墊上逗留、休息。</li>
            <li>應視自身狀況進行攀爬，熱身收操不可少。</li>
            <li>應注意自身及他人安全，攀爬時避免與他人發生碰撞。</li>
            <li>應依照正確方式墜落，避免跌落於軟墊邊緣。</li>
            <li>如發現設施異常請立即通報工作人員。</li>
            <li>嚴禁私自拆卸岩塊或破壞設備。</li>
            <li>本館禁止私人教學，並禁止攜帶危險物品入館。</li>
            <li>違反場館規範時，工作人員得視情況制止及處理。</li>
            <li>其他未盡事宜，得由館方依現場狀況適時修訂。</li>
          </ul>
        </div>
        <div class="checkbox-block">
          <label><input type="checkbox" id="agree2" required> 我已知悉並同意遵守入場須知與安全守則</label>
        </div>
        <div class="nav-btns">
          <button type="button" id="to-step-1">上一步</button>
          <button type="button" id="to-step-3">下一頁</button>
        </div>
      </div>
      <!-- Step 3 個人資料 -->
      <div id="step-3" style="display:none">
        <h2 class="page-title">基本資料填寫</h2>
        <label>姓名<input type="text" id="name" required></label>
        <label>身分證字號<input type="text" id="idnumber" required></label>
        <label>性別</label>
        <div class="radio-group">
          <label><input type="radio" name="gender" value="男" required> 男</label>
          <label><input type="radio" name="gender" value="女" required> 女</label>
        </div>
        <label>出生年月日<input type="date" id="dob" required></label>
        <label>連絡電話<input type="tel" id="phone" required></label>
        <label>緊急聯絡人<input type="text" id="emergency_contact" required></label>
        <label>緊急聯絡人關係<input type="text" id="emergency_relation" required></label>
        <label>緊急聯絡人電話<input type="tel" id="emergency_phone" required></label>
        <div class="nav-btns">
          <button type="button" id="to-step-2b">上一步</button>
          <button type="button" id="to-step-4">下一頁</button>
        </div>
      </div>
      <!-- Step 4 簽名 -->
      <div id="step-4" style="display:none">
        <h2 class="page-title">電子簽名確認</h2>
        <div class="canvas-block">
          <label>參與者簽名（必填）</label>
          <canvas id="signature1" class="sign-canvas"></canvas>
          <button type="button" class="clear-btn" id="clear1">清除簽名</button>
        </div>
        <div class="canvas-block">
          <label>家長／監護人簽名（如未滿18歲必填）</label>
          <canvas id="signature2" class="sign-canvas"></canvas>
          <button type="button" class="clear-btn" id="clear2">清除簽名</button>
        </div>
        <div class="nav-btns">
          <button type="button" id="to-step-3b">上一步</button>
        </div>
        <button type="submit" class="submit-btn">送出</button>
      </div>
      <!-- Step 5 成功頁 -->
      <div id="final-page" style="display:none">
        <div style="font-size:2.5em; margin-top:1.2em; color:var(--main-blue);">✅</div>
        <div style="font-size:1.3em; margin: 1em 0 0.2em 0; color:var(--main-blue);"><b>已成功送出！</b></div>
        <div style="font-size:1.06em; color:#232629;">感謝您填寫同意書，<br>祝您攀登愉快、平安順利！</div>
        <button class="final-btn" id="more-btn" type="button">提交更多資料</button>
      </div>
    </form>
  </div>
</div>
<script>
  // --- 分頁切換 ---
  const step1 = document.getElementById('step-1');
  const step2 = document.getElementById('step-2');
  const step3 = document.getElementById('step-3');
  const step4 = document.getElementById('step-4');
  const finalPage = document.getElementById('final-page');
  function showStep(step) {
    step1.style.display = (step===1)?'block':'none';
    step2.style.display = (step===2)?'block':'none';
    step3.style.display = (step===3)?'block':'none';
    step4.style.display = (step===4)?'block':'none';
    finalPage.style.display = (step===5)?'block':'none';
    window.scrollTo(0,0);
    if (step === 4) setTimeout(resizeAll, 50); // 進入簽名頁時重繪canvas
  }
  document.getElementById('to-step-2').onclick = function() {
    if(!document.getElementById('agree1').checked){
      alert('請勾選同意後才能繼續');
      return;
    }
    showStep(2);
  };
  document.getElementById('to-step-1').onclick = function() { showStep(1); };
  document.getElementById('to-step-3').onclick = function() {
    if(!document.getElementById('agree2').checked){
      alert('請勾選同意後才能繼續');
      return;
    }
    showStep(3);
  };
  document.getElementById('to-step-2b').onclick = function() { showStep(2); };
  document.getElementById('to-step-4').onclick = function() {
    const fields = [
      'name','idnumber','dob','phone','emergency_contact','emergency_relation','emergency_phone'
    ];
    for(let id of fields){
      if(!document.getElementById(id).value){
        document.getElementById(id).focus();
        alert('請完整填寫所有資料');
        return;
      }
    }
    if(!document.querySelector('input[name="gender"]:checked')){
      alert('請選擇性別');
      return;
    }
    showStep(4);
  };
  document.getElementById('to-step-3b').onclick = function() { showStep(3); };

  // --- 簽名區 ---
  let signaturePad1, signaturePad2, canvas1, canvas2;
  function resizeCanvas(canvas, pad) {
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    canvas.width = canvas.offsetWidth * ratio;
    canvas.height = 120 * ratio;
    canvas.style.height = "120px";
    canvas.style.width = "100%";
    canvas.getContext('2d').scale(ratio, ratio);
    pad.clear();
  }
  function resizeAll() {
    resizeCanvas(canvas1, signaturePad1);
    resizeCanvas(canvas2, signaturePad2);
  }
  window.onload = function() {
    canvas1 = document.getElementById('signature1');
    canvas2 = document.getElementById('signature2');
    signaturePad1 = new SignaturePad(canvas1);
    signaturePad2 = new SignaturePad(canvas2);
    window.addEventListener('resize', resizeAll);
    setTimeout(resizeAll, 200);
    document.getElementById('clear1').onclick = ()=>signaturePad1.clear();
    document.getElementById('clear2').onclick = ()=>signaturePad2.clear();
  };

  // 判斷年齡（未滿18必簽家長）
  function isMinor() {
    const dob = document.getElementById('dob').value;
    if(!dob) return false;
    const today = new Date();
    const birth = new Date(dob);
    let age = today.getFullYear() - birth.getFullYear();
    if(today.getMonth()<birth.getMonth()||(today.getMonth()===birth.getMonth()&&today.getDate()<birth.getDate())){
      age--;
    }
    return age < 18;
  }

  // --- 表單送出 ---
  document.getElementById('waiverForm').onsubmit = async function(e) {
    e.preventDefault();
    if(signaturePad1.isEmpty()){
      alert('請參與者簽名');
      return;
    }
    if(isMinor() && signaturePad2.isEmpty()){
      alert('未滿18歲必須由家長／監護人簽名');
      return;
    }
    // 組資料
    const formData = new FormData();
    formData.append('姓名', document.getElementById('name').value);
    formData.append('身分證字號', document.getElementById('idnumber').value);
    formData.append('性別', document.querySelector('input[name="gender"]:checked').value);
    formData.append('出生年月日', document.getElementById('dob').value);
    formData.append('連絡電話', document.getElementById('phone').value);
    formData.append('緊急聯絡人', document.getElementById('emergency_contact').value);
    formData.append('緊急聯絡人關係', document.getElementById('emergency_relation').value);
    formData.append('緊急聯絡人電話', document.getElementById('emergency_phone').value);
    formData.append('條款1同意', document.getElementById('agree1').checked ? '同意' : '');
    formData.append('條款2同意', document.getElementById('agree2').checked ? '同意' : '');
    formData.append('參與者簽名', signaturePad1.toDataURL());
    formData.append('家長簽名', signaturePad2.isEmpty() ? '' : signaturePad2.toDataURL());
    // Google Apps Script 網址
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyAPGl3J0Ntz0FNWvCWiAL6NH6rmBEim6R9p50xrKTgUDPurGF_jzA1KTTuhLRmQGZ_/exec';
    try{
      const res = await fetch(scriptURL, { method:'POST', body:formData });
      if(res.ok){
        showStep(5); // 跳到成功頁
        document.getElementById('waiverForm').reset();
        signaturePad1.clear();
        signaturePad2.clear();
      }else{
        alert('送出失敗，請稍後再試');
      }
    }catch(err){
      alert('送出過程發生錯誤');
    }
  };

  // 成功頁：再填一份
  document.getElementById('more-btn').onclick = function() {
    showStep(1);
  };
</script>
</body>
</html>
